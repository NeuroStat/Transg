---
title: "Advantage of two scans in small populations demonstrated with a transgender dataset."
author: "Freya Acar"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache=TRUE)
```

# Introduction
We have a dataset where FreeSurfer was used to determine cortical and subcortical brain anatomy in cis- and transgender population. For every participant two scans were administered (T1 and T2) and an average of both scans was computed. In this report we analyze the data from one scan and the average of both scans. Later on we show the advantage and increase in power obtained by admninistering 2 scans. 
One participant (P22) was removed from the analysis because no anatomical data was available for this participant.

# Actual data
We first read in the data. In data.all all available measurements are stored (descriptive and anatomical) while in data.hyp the anatomical results for every region of interest stored. Both files contain data of T1, T2 and the average. 
```{r ReadData}
# Read in data
data.all <- read.csv("../1.Data/Behzad_all.csv", sep=";", dec=",")
data.hyp <- read.csv("../1.Data/Behzad_hyp.csv", sep=";", dec=",")

# Check data
dim(data.hyp)
dim(data.all)
```

The regions we are interested in are the cerebellum, caudate, putamen, nucleus accumenbens, thalamus, fusiform, pre-central gyrus, post-central gyrus, frontal poles and inferior parietal gyrus. Here we list the variables we selected from FreeSurfer that comply with these regions.
```{r roi}
# Regions of interest
names(data.hyp[,55:80])
```
## Descriptives
In this section population parameters are presented. 

###Gender
There were 60 cisgender and 80 transgender participants. One participant (P22) was removed from the analysis because no anatomical data was available for this participant. 
```{r Gender}
ng1 <- sum(data.all[,2]==1)
ng2 <- sum(data.all[,2]==2)
ng3 <- sum(data.all[,2]==3)
ng4 <- sum(data.all[,2]==4)

paste("Cisgender women = ", ng1, ", cisgender men = ", ng2, 
      ", transgender men = ", ng3, ", transgender women = ",ng4, sep="")

hist(data.all[,2], xlab = "Gender", xaxt = "n", col = "seagreen3", 
     border = "white", main = "Frequency of gender")
axis(1,at=c(1:4),labels=c("CW", "CM", "TM", "TW"))
```

###Age
```{r Age}
summary(data.all[,4])

hist(data.all[,4], xlab = "Age", col = "seagreen3", border = "white", 
     main = "Histogram of age distribution", breaks = length(unique(data.all[,4])))
```

Age of the participants ranged from 16 to 44. If we look at the distribution of age in the cis- and transgender group we see that the range is similar in both groups.

```{r agediff}
# Cisgender group
summary(data.all[data.all[,2]<3,4])

# Transgender group
summary(data.all[data.all[,2]>2,4])
```


###Social-Economic Status
```{r SES}
table(data.all[,5])
```

###Level of education
```{r Education}
table(data.all[,6])
```

###Handedness
```{r Handedness}
table(data.all[,7])
```

###Gender identity
```{r Gender identity}
summary(data.all[,8])
table(data.all[,8])

# Cisgender women
summary(data.all[data.all[,2]==1,8])

# Cisgender men
summary(data.all[data.all[,2]==2,8])

# Transgender women
summary(data.all[data.all[,2]==3,8])

# Transgender men
summary(data.all[data.all[,2]==4,8])
```

###Sexual orientation
```{r Sexual orientation}
summary(data.all[,9])
table(data.all[,9])

# Cisgender women
summary(data.all[data.all[,2]==1,9])

# Cisgender men
summary(data.all[data.all[,2]==2,9])

# Transgender women
summary(data.all[data.all[,2]==3,9])

# Transgender men
summary(data.all[data.all[,2]==4,9])
```


### Mental illnesses
There are no available measures for the cisgender group. 
####Somatization
```{r Somatization}
table(data.all[,22])
```

####Obsessive-compulsive disorder
```{r OCD}
table(data.all[,23])
```
Among the cisgender participants 1 had a history of obsession.

####Interpersonal sensitivity
```{r Interpersonal sensitivity}
table(data.all[,24])
```

####Depression
```{r Depression}
table(data.all[,25])
```
Among the cisgender participants 3 had a history of depression.

####Anxiety
```{r Anxiety}
table(data.all[,26])
```
Among the cisgender participants 1 had a history of a general anxiety disorder.

####Hostility
```{r Hostility}
table(data.all[,27])
```

####Phobic anxiety
```{r Phobic Anxiety}
table(data.all[,28])
```

####Paranoia
```{r Paranoia}
table(data.all[,29])
```

####Psychotism
```{r Psychotism}
table(data.all[,30])
```

####Global severity
```{r Global severity}
table(data.all[,31])
```

#### Cisgender group
Past psychiatric condition
Out of 60 cisgender participants 3 had a history of depression, 1 reported a general anxiety disorder and 1 had a history of obsession. 

Past medical condition
Out of 60 cisgender participants 3 reported migraine, 1 reported left ear surgery, 1 participant had suffered from heart palpitations, 1 participants reported a history of meningitis, 1 participant reported they had asthma as a child and 1 partcipants reported favism.

## Analysis of 1 measurement
```{r onemeas}
bg <- 3
nd <- 28
ln <- nd-bg
# Object to save p-values of ANOVA
pan <- array(data=NA, dim = ln)

# Compute ANOVA for every predictor and save p-value
for(i in bg:nd){
  tempan <- aov(data.hyp[,i] ~ as.factor(data.hyp[,2]))
  pan[i-bg+1] <- unlist(summary(tempan))[9]
}

# FDR correction on p-values to correct for multiple testing
pancorr <- p.adjust(pan, method = "bonferroni")
round(pancorr,3)
sum(pancorr < 0.05)
names(data.hyp[,which(pancorr < 0.05) + bg - 1])
```

## Analysis of the average
```{r average two}
bg <- 55
nd <- 80
ln <- nd-bg+1

# Object to save p-values of ANOVA
pan <- array(data=NA, dim = ln)

# Compute ANOVA for every predictor and save p-value
for(i in bg:nd){
  tempan <- aov(data.hyp[,i] ~ as.factor(data.hyp[,2]))
  pan[i-bg+1] <- unlist(summary(tempan))[9]
  
  # construct boxplot for every region
  boxplot(data.hyp[,i] ~ as.factor(data.hyp[,2]))
}

# FDR correction on p-values to correct for multiple testing
pancorr <- p.adjust(pan, method = "bonferroni")
round(pancorr,3)
sum(pancorr < 0.05)
names(data.hyp[,which(pancorr < 0.05) + bg - 1])
```

Why are there less regions for which the difference is statistically significant when the average is used compared to when one measure is used?

###Post-hoc tests
We conduct post-hoc t-tests on the statistically significant regions to determine which group differences cause the effect.
```{r posthoc}

```

## Correlation between T1 and T2
```{r corr all}
bg <- 36
nd <- 108
ln <- nd-bg+1

# Object to save correlations
corrall <- array(data=NA, dim = ln)

# Compute ANOVA for every predictor and save p-value
for(i in bg:nd){
  corrall[i-bg+1] <- cor(x = data.all[,i], y = data.all[,i + ln + 1])
}

summary(corrall)
```

```{r corr hyp}
bg <- 3
nd <- 28
ln <- nd-bg+1

# Object to save correlations
corrhyp <- array(data=NA, dim = ln)

# Compute ANOVA for every predictor and save p-value
for(i in bg:nd){
  corrhyp[i-bg+1] <- cor(x = data.hyp[,i], y = data.hyp[,i + ln])
}

summary(corrhyp)
```

# Simulations
## Intro
## Code
```{r Simulations setup, echo = FALSE, warning = FALSE, include = FALSE}
# Working directory
```
First we need to define the parameters of our simulations. 
```{r Simulations parameters}
# variance/sd epsilon
seps <- 1  

# Number of simulations
asim <- 10

# Effect size
delta <- 0.8

# Number of participants
n <- 30
n.1 <- n/2      # in the first group
n.2 <- n/2      # in the second group

# Level of statistical significance 
alpha <- 0.05

# Correlation between first and second measurement
rho <- seq(0.01,0.99,0.01)
```

Then we prepare objects to store our results
```{r Create objects}
# Number of simulations
pow.mean1<-vector("numeric",length(rho))
pow.mean2<-vector("numeric",length(rho))
pow.mean3<-vector("numeric",length(rho))
pow.mean4<-vector("numeric",length(rho))
```

```{r Load libraries, warning=FALSE, echo=FALSE}
# Libraries
library(lme4)
library(lmerTest)
```

```{r Simulations code}
# Loop over preset correlations between measure 1 and measure 2
for(i in 1:length(rho)){
  # Create objects to store power in for every simulations
  pow.1<-vector("numeric",asim)
  pow.2<-vector("numeric",asim)
  pow.3<-vector("numeric",asim)
  pow.4<-vector("numeric",asim)
  
  for(k in 1:asim){
    # Scenario 1: lower bound of power curve
    # two groups with equal amount of subjects, groups differ with an effect size delta
    # Construct a vector that determines in which group each subject falls
    x<-c(rep(1,n.1),rep(0,n.2))
    
    # Vector with observations in the set of participants
    y<-rnorm(n,0,seps)       
    # Add an effect size to the first group
    y[1:n.1]<-y[1:n.1]+delta    
    
    # Boolean of whether an effect is detected, this is later used to compute the power
    pow.1[k]<-summary(lm(y~x))$coef[2,4]<alpha
    
    # Scenario 2: upper bound of power curve
    # two groups with equal amount of subjects, twice as many as scenario 1, groups differ with an effect size delta
    # Construct a vector that determines in which group each subject falls
    x2<-c(rep(1,(n.1*2)),rep(0,(n.2*2)))
    
    # Vector with observations in the set of participants
    y2<-rnorm(n*2,0,seps)
    # Add an effect size to the first group
    y2[1:(n.1*2)]<-y2[1:(n.1*2)]+delta
    
    # Boolean of whether an effect is detected, this is later used to compute the power
    pow.2[k]<-summary(lm(y2~x2))$coef[2,4]<alpha
    
    # Scenario 3: two measurements for every subject, same amount of subjects as in scenario 1
    # two groups with equal amount of subjects, correlation between measurements, groups differ with an effect size delta
    # Construct a vector that determines in which group each subject falls
    x3<-c(rep(1,n.1),rep(0,n.2),rep(1,n.1),rep(0,n.2))
    
    # Vector with first observation of every participant
    y3<-rnorm(n,0,seps)
    # Factor to multiply second set of observations with to obtain results in line with predefined correlation
    alpac<-sqrt(rho[i]^2/(1-rho[i]^2)*seps)
    # Construct second set of observations that are correlated with first set (y3)
    y3.2u<-alpac*y3+rnorm(n)
    y3.2<-y3.2u/sqrt(var(y3.2u))
    # Add effect size to the first group of participants
    y3[1:n.1]<-y3[1:n.1]+delta
    y3.2[1:n.1]<-y3.2[1:n.1]+delta
    # Combine both observations in 1 vector
    y3o<-c(y3,y3.2)
    
    # Define subject numbers
    subject<-rep(1:n,2)
    # Construct mixed model
    mm<-lmer(y3o ~ x3 + (1 | subject))   
    # Boolean of whether an effect is detected, this is later used to compute the power
    pow.3[k]<-summary(mm)$coef[2,5]<alpha
    
    # Scenario 4: What if we work with the average?
    y3m<-(y3+y3.2)/2
    # Boolean of whether an effect is detected, this is later used to compute the power
    pow.4[k]<-summary(lm(y3m~x))$coef[2,4]<alpha
  }
  pow.mean1[i]<-mean(pow.1)
  pow.mean2[i]<-mean(pow.2)
  pow.mean3[i]<-mean(pow.3)
  pow.mean4[i]<-mean(pow.4)
}
```


## Results
```{r Simulation results}
# power of taking both measures into account
plot(rho,pow.mean1,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean2,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean3,ylim=c(0,1), type="p", col = "goldenrod3", pch = 2)

# power of using the average
plot(rho,pow.mean1,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean2,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean3,ylim=c(0,1), type="p", col = "seagreen3", pch = 16)
```

If we overlay both plots we see that there is a lot of overlap. This can also be demonstrated by looking at the results that are exactly the same.
```{r Compare results}
table(pow.mean3==pow.mean4)

# Overlap of both plots
plot(rho,pow.mean1,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean2,ylim=c(0,1), type="l")
par(new = TRUE)
plot(rho,pow.mean3,ylim=c(0,1), type="p", col = "goldenrod3", pch = 2)
par(new = TRUE)
plot(rho,pow.mean3,ylim=c(0,1), type="p", col = "seagreen3", pch = 16)
```



# Discussion

```{r temp, echo=FALSE}

```
